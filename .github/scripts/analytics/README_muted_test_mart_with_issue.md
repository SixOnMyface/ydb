# Enhanced Muted Test Data Mart with GitHub Issue Links

This documentation describes the enhanced muted test data mart that includes GitHub issue links for muted tests.

## Overview

The enhanced data mart `test_results/analytics/test_muted_monitor_mart_with_issue` extends the standard muted test monitor data mart by adding GitHub issue information for each muted test.

## Architecture

### New SQL-Based Approach

The system now uses a cleaner, more maintainable architecture:

1. **GitHub Issue Mapping Table** (`test_results/analytics/github_issue_mapping`):
   - Created by `.github/scripts/analytics/github_issue_mapping.py`
   - Contains mappings between test names and GitHub issues
   - Includes: `full_name`, `github_issue_url`, `github_issue_title`, `github_issue_number`, `branches`

2. **Enhanced Data Mart**:
   - Generated by SQL query in `.github/scripts/analytics/data_mart_queries/test_muted_monitor_mart_with_issue.sql`
   - Uses LEFT JOIN between muted test data and GitHub issue mappings
   - Leverages existing `data_mart_executor.py` infrastructure

### Data Sources

- `test_results/analytics/tests_monitor` - Source of muted test data
- `github_data/issues` - Source of GitHub issue data
- `test_results/analytics/github_issue_mapping` - Test-to-issue mappings

### Issue Matching Logic

- Uses shared utilities in `.github/scripts/github_issue_utils.py`
- Parses GitHub issue bodies to extract test names using the same logic as `update_mute_issues.py`
- Looks for test names between `<!--mute_list_start-->` and `<!--mute_list_end-->` markers
- Falls back to parsing simple "Mute:" prefixed lists
- Matches tests with issues based on test name and branch compatibility

### Enhanced Columns

The data mart includes all original columns from the standard muted test monitor plus:
- `github_issue_url` - Direct link to the GitHub issue
- `github_issue_title` - Title of the GitHub issue  
- `github_issue_number` - Issue number for easy reference

## Execution Flow

1. **GitHub Issue Mapping** (`.github/scripts/analytics/github_issue_mapping.py`):
   - Fetches GitHub issues from `github_data/issues`
   - Uses shared utilities to parse issue bodies and extract test names
   - Creates/updates the `github_issue_mapping` table

2. **Enhanced Data Mart** (SQL-based):
   - Uses the standard `data_mart_executor.py` with `test_muted_monitor_mart_with_issue.sql`
   - Performs LEFT JOIN between muted test data and GitHub issue mappings
   - Handles branch-specific matching preferences

Both run as part of the `collect_analytics_fast.yml` workflow every 30 minutes.

## Benefits

- **Separation of Concerns**: GitHub issue mapping is separate from muted test logic
- **Performance**: SQL-based joins are faster than Python processing
- **Maintainability**: Uses existing SQL infrastructure and shared utilities
- **Scalability**: Leverages YDB's columnar storage and partitioning

## Error Handling

- Gracefully handles missing source tables
- Continues processing even if GitHub issues data is unavailable  
- Tests without associated issues have NULL values in the GitHub issue columns
- Robust branch matching with fallback to 'main' branch

## Example Usage

```sql
-- Find muted tests with their associated GitHub issues
SELECT 
    full_name,
    branch,
    state,
    days_in_state,
    github_issue_url,
    github_issue_title
FROM `test_results/analytics/test_muted_monitor_mart_with_issue`
WHERE github_issue_url IS NOT NULL
ORDER BY days_in_state DESC
```

```sql
-- Find muted tests that don't have associated GitHub issues
SELECT 
    full_name,
    branch,
    state,
    days_in_state,
    resolution
FROM `test_results/analytics/test_muted_monitor_mart_with_issue`
WHERE github_issue_url IS NULL
AND resolution = 'MUTED: delete candidate'
ORDER BY days_in_state DESC
```

## Maintenance

- GitHub issue mapping table: Refreshed every 30 minutes, 60-day TTL
- Enhanced data mart: Refreshed every 30 minutes, 30-day TTL  
- Both use columnar storage with hash partitioning for optimal performance